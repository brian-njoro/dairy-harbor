{% extends "base.html" %}

{% block title %}Cattle{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- Cattle management content -->
        <h2 class="mt-5 mb-3 fw-bold text-info text-center">Cattle Management</h2>

        <!--Cattle summary-->
        <div class="row mb-3">

            <!-- Cattle Numbers -->
            <div class="col-sm-4 text-center mb-3 mb-sm-0">
                <div class="card border border-2 border-info shadow-lg bg-white">
                    <div class="card-body">
                        <h5 class="card-title fw-bold">Total Cattle</h5>
                        <p class="card-text text-info">
                            Cows:<span class="text-dark" id="totalCows">{{ admin.cattle | length }}</span>
                        </p>
                        <p class="card-text text-info">
                            Bulls:<span class="text-dark" id="totalBulls"> 0</span>
                        </p>
                        <p class="card-text text-info">
                            Calves:<span class="text-dark" id="totalCalves"> 0</span>
                        </p>
                        <p class="card-text text-info">
                            Total cattle:<span class="text-dark" id="totalCows">{{ admin.cattle | length }}</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Cattle Status card -->
            <div class="col-sm-4 text-center mb-3 mb-sm-0">
                <div class="card border border-2 border-info shadow-lg bg-white">
                    <div class="card-body">
                        <h5 class="card-title fw-bold">Cattle Status</h5>
                        <p class="card-text text-info">
                            Sick Cows:<span class="text-dark" id="sickCows"> 1</span>
                        </p>
                        <p class="card-text text-info">
                            Pregnant Cows:<span class="text-dark" id="pregnantCows"> 0</span>
                        </p>
                        <p class="card-text text-info">
                            Weaning Calves:<span class="text-dark" id="totalCows"> 2</span>
                        </p>
                        <p class="card-text text-info">
                            Cattle vaccinated:<span class="text-dark" id="CattleVaccinated">7</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Add Cattle Card -->
            <div class="col-sm-4 text-center mb-3 mb-sm-0">
                <div class="card border border-2 border-info shadow-lg bg-white">
                    <div class="card-body">
                        <h5 class="card-title text-info fw-bold">ADD CATTLE</h5>
                        <p class="card-text">Add and manage cattle profiles by tracking all animals health and productivity history.</p>

                        <!-- Button to add new cattle -->
                        <div class="mb-0">
                            <button type="button" class="btn btn-info shadow-md" data-bs-toggle="modal" data-bs-target="#modalCattleRegistration" id='cattleRegistration'>
                                Add Cattle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal for Cattle Registration -->
            <div class="modal fade" id="modalCattleRegistration" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border border-3 border-info">
                        <div class="modal-header">
                            <h5 class="modal-title text-info fw-bold">Add Cattle</h5>
                            <button type="button" class="btn-close bg-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body">
                            <form id="cattleForm">
                                <!--Cattle Name-->
                                <div class="mb-3">
                                    <label for="name" class="form-label text-dark fw-bold">Name:</label>
                                    <input type="text" id="name" class="form-control" required>
                                </div>

                                <!--Date Of Birth-->
                                <div class="mb-3">
                                    <label for="dateOfBirth" class="form-label text-dark fw-bold">Date of Birth:</label>
                                    <input type="date" id="dateOfBirth" class="form-control" required>
                                </div>

                                <!--Cattle Breed-->
                                <div class="mb-3">
                                    <label for="breed" class="form-label text-dark fw-bold">Breed:</label>
                                    <select class="form-control" name="breed" id="breed" required>
                                        <option value="Holstein_Friesian">Holstein Friesian</option>
                                        <option value="Jersey">Jersey</option>
                                        <option value="Guernsey">Guernsey</option>
                                        <option value="Brown_Swiss">Brown Swiss</option>
                                        <option value="Ayrshire">Ayrshire</option>
                                        <option value="Milking_Shorthorn">Milking Shorthorn</option>
                                        <option value="Dutch_Belted">Dutch Belted (Lakenvelder)</option>
                                        <option value="Red_White_Holstein">Red and White Holstein</option>
                                        <option value="Montbéliarde">Montbéliarde</option>
                                        <option value="Swedish_Red_White">Swedish Red and White</option>
                                    </select>
                                </div>

                                <!--Fathers Breed-->
                                <div class="mb-3">
                                    <label for="fatherBreed" class="form-label text-dark fw-bold">Father's Breed:</label>
                                    <select class="form-control" name="fatherBreed" id="fatherBreed" required>
                                        <option value="Holstein_Friesian">Holstein Friesian</option>
                                        <option value="Jersey">Jersey</option>
                                        <option value="Guernsey">Guernsey</option>
                                        <option value="Brown_Swiss">Brown Swiss</option>
                                        <option value="Ayrshire">Ayrshire</option>
                                        <option value="Milking_Shorthorn">Milking Shorthorn</option>
                                        <option value="Swedish_Red_White">Swedish Red and White</option>
                                        <option value="Montbéliarde">Montbéliarde</option>
                                        <option value="Norwegian_Red">Norwegian Red</option>
                                        <option value="Ayrshire">Ayrshire</option>
                                        <option value="Dutch_Belted">Dutch Belted (Lakenvelder)</option>
                                    </select>
                                </div>

                                <!--Mothers' Breed -->
                                <div class="mb-3">
                                    <label for="motherBreed" class="form-label text-dark fw-bold">Mother's Breed:</label>
                                    <select class="form-control" name="motherBreed" id="motherBreed" required>
                                        <option value="Holstein_Friesian">Holstein Friesian</option>
                                        <option value="Jersey">Jersey</option>
                                        <option value="Guernsey">Guernsey</option>
                                        <option value="Brown_Swiss">Brown Swiss</option>
                                        <option value="Ayrshire">Ayrshire</option>
                                        <option value="Milking_Shorthorn">Milking Shorthorn</option>
                                        <option value="Dutch_Belted">Dutch Belted (Lakenvelder)</option>
                                        <option value="Red_White_Holstein">Red and White Holstein</option>
                                        <option value="Montbéliarde">Montbéliarde</option>
                                        <option value="Swedish_Red_White">Swedish Red and White</option>
                                    </select>
                                </div>

                                <!--Method Of Breeding-->
                                <div class="mb-3">
                                    <label for="methodBred" class="form-label text-dark fw-bold">Method Bred:</label>
                                    <select class="form-control" name="methodBred" id="methodBred" required>
                                        <option value="Natural">Natural</option>
                                        <option value="ArtificialInsemination">Artificial Insemination</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="status" class="form-label text-dark fw-bold">Status:</label>
                                    <select class="form-control" name="status" id="status" required>
                                        <option value="healthy">Healthy</option>
                                        <option value="sick">Sick</option>
                                        <option value="pregnant">Pregnant</option>
                                        <option value="weaning">Weaning</option>
                                    </select>
                                </div>

                                <!--Admin Id-->
                                <div class="mb-3">
                                    <label for="adminId" class="form-label text-dark fw-bold">Admin ID:</label>
                                    <input type="hidden" id="adminId" value="{{ admin.id }}">
                                    <p>{{ admin.username }}</p>
                                </div>
                            </form>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-info" id="addCattleButton">Add Cattle</button>
                        </div>

                    </div>
                </div>
            </div>

        </div>
        <!-- / Cattle summary -->

        

        <div class="row justify-content-between mx-auto px-auto">

        </div>

        <div class="card text-center bg-transparent border border-info">
            
            <div class="card-body">
                
                <!-- Cattle List -->
                <div class="mt-5" id='cattle-List'>
                    <h3 class="fs-3 text-info fw-bold">Cattle List</h3>
                    <div class="card border border-info border-3 shadow-lg cattle-table">
                        <!-- Cattle History -->
                        <div class="card bg-light border-none ">
                            <div class="table-responsive text-nowrap border">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-info fw-bold">#</th>
                                            <th class="text-info fw-bold">Serial Number</th>
                                            <th class="text-info fw-bold">Name</th>
                                            <th class="text-info fw-bold">Breed</th>
                                            <th class="text-info fw-bold">Status</th>
                                            <th class="text-info fw-bold">Date Of Birth</th>
                                            <th class="text-info fw-bold">Delete</th>
                                            
                                        </tr>
                                    </thead>

                                    <tbody id="cattleList">
                                        <!-- Cattle items will be dynamically added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!--Cattle History-->
                    </div>
                </div>
                <!-- / Cattle List -->

                <!-- Modal For Cow Profile -->
                <div class="modal fade" id="modalCowProfile" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border border-3 border-info">

                            <div class="modal-header">
                                <h5 class="modal-title text-info fw-bold fs-2">Cow Profile</h5>
                                <button type="button" class="btn-close bg-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                
                            <div class="modal-body">
                                <!-- Cow Profile -->
                                <div class="row mb-5">
                                    <div class="col-lg">
                                        <div class="card mb-3 border border-2 border-info shadow-lg">
                                            <div class="row g-0">
                                                <div class="col bg-light">
                                                    <img src="./static/auth/img/p10.png" class="card-img-top" alt="cowprofile">
                                                    <div class="card-body">
                                                        <p class="card-text"><span class="text-info fw-bold fs-4">Serial Number:</span> <span id="serialNumber"></span></p>
                                                        <p class="card-text"><span class="text-info fw-bold fs-4">Name:</span> <span id="cowName"></span></p>
                                                        <p class="card-text"><span class="text-info fw-bold fs-4">Date Of birth:</span> <span id="dateOfBirth"></span></p>
                                                        <p class="card-text"><span class="text-info fw-bold fs-4">Breed:</span> <span id="cowBreed"></span></p>
                                                        <p class="card-text"><span class="text-info fw-bold fs-4">Father's Breed:</span> <span id="fatherBreed"></span></p>
                                                        <p class="card-text"><span class="text-info fw-bold fs-4">Mother Breed:</span> <span id="motherBreed"></span></p>
                                                        <a id="delete" class="btn btn-danger ms-2">Delete</a>
                                                        <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--/ Cow Profile -->

                                <!-- Cow History Table rows -->
                                <div class="card bg-light border border-info border-2 shadow-lg mb-5">
                                    <h5 class="card-header text-dark fw-4 fw-bold">History</h5>
                                    <div class="table-responsive text-nowrap border">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th class='text-info fw-bold fs-6'>Serial Number</th>
                                                    <th class='text-info fw-bold fs-6'>Name</th>
                                                    <th class='text-info fw-bold fs-6'>Breed</th>
                                                    <th class='text-info fw-bold fs-6'>Date Of Birth</th>
                                                </tr>
                                            </thead>

                                            <tbody class="table-border-bottom-0" id="cattleHistory">
                                            </tbody>

                                        </table>
                                    </div>
                                </div>
                                <!--/ Cow History Table rows -->
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- / Modal For cow Profile-->

            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Document is ready');
    
            // Fetch cattle list when the page is loaded
            fetchCattleList();
    
            // Add event listener for the "Add Cattle" button
            const addCattleButton = document.getElementById('addCattleButton');
            if (addCattleButton) {
                addCattleButton.addEventListener('click', addCattle);
            } else {
                console.error('Add Cattle button not found');
            }
        });
    
        function fetchCattleList() {
            console.log('Fetching cattle list...');
            fetch('/cattle/get')
                .then(response => {
                    console.log('Received response from /cattle/get');
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching cattle list:', data.error);
                        return;
                    }
    
                    console.log('Received data:', data);
                    const cattleList = document.getElementById('cattleList');
                    cattleList.innerHTML = ''; // Clear existing list items
    
                    data.forEach((cattle, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${cattle.serial_number}</td>
                            <td>${cattle.name}</td>
                            <td>${cattle.breed}</td>
                            <td>${cattle.status}</td>
                            <td>${cattle.date_of_birth}</td>
                            <td><button class="btn btn-danger btn-sm" onclick="deleteCattle('${cattle.serial_number}')">Delete</button></td>
                        `;
                        cattleList.appendChild(row);
                    });
    
                    // Update cattle count
                    updateCattleCount(data.length);
                })
                .catch(error => {
                    console.error('Error fetching cattle list:', error);
                });
        }
    
        function deleteCattle(serialNumber) {
            console.log(`Deleting cattle with serial number ${serialNumber}`);
            fetch(`/cattle/${serialNumber}`, {
                method: 'DELETE',
            })
            .then(response => {
                console.log('Received response from DELETE /cattle');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                console.log(`Cattle with serial number ${serialNumber} deleted successfully.`);
                // Refresh cattle list after deletion
                fetchCattleList();
            })
            .catch(error => {
                console.error(`Error deleting cattle with serial number ${serialNumber}:`, error);
            });
        }
    
        function addCattle() {
            console.log('Add Cattle button clicked');
            
            const name = document.getElementById('name').value;
            const dateOfBirth = document.getElementById('dateOfBirth').value;
            const breed = document.getElementById('breed').value;
            const status = document.getElementById('status').value;
            const fatherBreed = document.getElementById('fatherBreed').value;
            const motherBreed = document.getElementById('motherBreed').value;
            const methodBred = document.getElementById('methodBred').value;
            const adminId = document.getElementById('adminId').value;
            
            console.log('Form Data:', { name, dateOfBirth, breed, status, fatherBreed, motherBreed, methodBred, adminId });
    
            const formData = {
                name: name,
                date_of_birth: dateOfBirth,
                breed: breed,
                status: staus,
                father_breed: fatherBreed,
                mother_breed: motherBreed,
                method_bred: methodBred,
                admin_id: adminId
            };
    
            fetch('/cattle/post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Fetch response received');
                if (!response.ok) {
                    console.error(`HTTP error! Status: ${response.status}`);
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Cattle added successfully:', data);
                // Close the modal after adding cattle
                const modalCloseButton = document.querySelector('#modalCattleRegistration .btn-close');
                if (modalCloseButton) {
                    console.log('Closing modal...');
                    modalCloseButton.click(); // Simulate click on close button
                } else {
                    console.error('Close button not found in modal');
                }
                // Clear input fields
                clearFormFields();
                // Refresh cattle list after adding new cattle
                fetchCattleList();
            })
            .catch(error => {
                console.error('Error adding cattle:', error);
            });
        }
    
        function clearFormFields() {
            console.log('Clearing form fields');
            document.getElementById('name').value = '';
            document.getElementById('dateOfBirth').value = '';
            document.getElementById('breed').value = '';
            document.getElementById('fatherBreed').value = '';
            document.getElementById('motherBreed').value = '';
            document.getElementById('methodBred').value = '';
            document.getElementById('adminId').value = '';
        }
    
        function updateCattleCount(count) {
            const totalCowsSpan = document.getElementById('totalCows');
            if (totalCowsSpan) {
                totalCowsSpan.textContent = count;
            } else {
                console.error('Total Cows span not found');
            }
        }
    </script>
    
        
{% endblock %}